# Circle.yml For stable.world
machine:
  python:
    version: 3.5.1
  environment:
    CONTAINER: stable.world
    GCLOUD_ZONE: us-central1-a
    GCLOUD_PROJECT: my-project-1-152801
  pre:
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  services:
    - docker
  post:
    - pyenv global 2.7.12 3.6.0

dependencies:
  pre:
    - sudo apt-get update
    - pip install --upgrade pip setuptools wheel
  override:
    - pip2 install -r test-requirements.txt
    - python2 setup.py develop

    - pip install -r test-requirements.txt
    - python3 setup.py develop

compile:
  override:
    - yarn app
    - cp ./bin/stable.world $CIRCLE_ARTIFACTS

    - echo "FROM python:2" | cat - Dockerfile.test.template > Dockerfile.py2
    - docker build -f Dockerfile.py2 -t testpy2 .

    - echo "FROM python:3" | cat - Dockerfile.test.template > Dockerfile.py3
    - docker build -f Dockerfile.py3 -t testpy3 .

test:
  override:
    - docker run testpy2 py.test /app/
    - docker run testpy3 py.test /app/
    - ./bin/stable.world --help

  post:

    - python setup.py sdist bdist_wheel
    - cp ./dist/* $CIRCLE_ARTIFACTS

deployment:
  development:
    branch: develop
    commands:
      - pyenv global 2.7.12
      - yarn run deploy:fetch
      - yarn run deploy:authorize
      - yarn run deploy:development
  master:
    branch: master
    commands:
      - pyenv global 2.7.12
      - yarn run deploy:fetch
      - yarn run deploy:authorize
      - yarn run deploy:master
